<!doctype html><html xmlns="http://www.w3.org/1999/xhtml"><head prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns#"><title>Buck: Immutable Value Types</title><link type="image/png" rel="shortcut icon" href="/buck/static/favicon.png" /><meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no" /><meta http-equiv="content-type" content="text/html;charset=utf-8"><link type="text/css" rel="stylesheet" href="/buck/google-code-prettify/prettify.css" ><link type="text/css" rel="stylesheet" href="/buck/static/buck.css"><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-40185670-1', 'github.io'); ga('send', 'pageview');</script><meta property="og:locale" content="en_US"><meta property="og:title" content="Immutable Value Types"><meta property="og:site_name" content="Buck: an Android build tool"><meta property="og:image" content="http://facebook.github.io/buck/static/og.png"><meta property="og:type" content="article"><meta property="og:description" content="Auto-generating values and Builders in Buck."><meta property="fb:admins" content="584556688222168"></head><body><div id="fb-root"></div><script>(function(d, s, id) {var js, fjs = d.getElementsByTagName(s)[0]; if (d.getElementById(id)) return; js = d.createElement(s); js.id = id; js.src = "//connect.facebook.net/en_US/all.js#xfbml=1&appId=584556688222168"; fjs.parentNode.insertBefore(js, fjs);}(document, 'script', 'facebook-jssdk'));</script><header class='topbar'><nav class='width'><a href='http://facebook.github.io/buck/'><h1>Buck</h1></a><ul class='menu'><li><a href='/buck/setup/quick_start.html'>Get Started</a><li><a href='https://groups.google.com/forum/#!forum/buck-build'>Group</a><li><a href='/buck/javadoc/'>API</a><li><a href='https://github.com/facebook/buck'>GitHub</a></ul></nav></header><section class='content'><div class='width'><article><h1>Immutable Value Types</h1><div class="overview"><p>Buck makes heavy use of immutable value types (Java objects which only hold <code>final</code> members and contain no business logic). These ease development and testing, as stateful APIs can be rewritten as stateless APIs which accept and return all the value types upon which they need to act.</p><p>Traditional Java value types cause two problems:</p><ol><li>Each value type requires a lot of manually-written boilerplate code, including <code><a href="http://docs.oracle.com/javase/7/docs/api/java/lang/Object.html#equals(java.lang.Object)">equals()</a></code>, <code><a href="http://docs.oracle.com/javase/7/docs/api/java/lang/Object.html#toString()">toString()</a></code>, and <code> <a href="http://docs.oracle.com/javase/7/docs/api/java/lang/Object.html#hashCode()">hashCode()</a></code></li><li>Value type constructors take large numbers of arguments, causing any change to the value type to necessitate changes in a large number of clients and tests</li></ol><p>To fix both of these issues, we use the <a href="http://immutables.github.io/immutable.html">Immutables.org</a> library automatically generate source code for immutable value types (including implementations for <code>equals()</code>, <code>toString()</code>, and <code>hashCode()</code>) as well as <a href="http://cantina.co/immutable-objects-and-the-builder-pattern/"><code>Builder</code>s</a> to put together instances of a value type piece by piece.<p>To use immutable value types in a Buck <code>java_library</code>, use the<code>java_immutables_library</code> function in your <code>BUCK</code> file.  For example:</code><pre class="prettyprint lang-py">
java_immutables_library(
  name = 'value',
  srcs = glob(['*.java'])
  deps = [
    '//third-party/java/guava:guava',
  ],
  visibility = ['PUBLIC'],
)
</pre>
<p>Then, declare an <code>interface</code> or <code>abstract</code> class containing the type and data accessors. Make sure to annotate it with <code>@org.immutables.value.Value.Immutable</code>:</p><pre class="prettyprint lang-java">
import com.google.common.base.Optional;
import org.immutables.value.Value;
import java.util.List;

@Value.Immutable
public interface Type {
  String name();
  List&lt;Long&gt; phoneNumbers();
  Optional&lt;String&gt; description();
}
</pre>
<p>Note that you must use <code>List&lt;T&gt;</code> instead of <code>ImmutableList&lt;T&gt;</code> in your interface. (Under the hood, it will be <code>ImmutableList</code>, but the source generation currently prefers the general type in the interface.)</p><p>This will generate two classes:</p><ul><li><code>ImmutableType</code>: A concrete implementation of <code>Type</code> with <code>private final</code> members</li><li><code>ImmutableType.Builder</code>: A <code>Builder</code> which generates instances of <code>ImmutableType</code></li></ul><p>For example, to generate an instance of and check its members in a unit test:</p><pre class="prettyprint lang-java">
    Type t = ImmutableType.builder()
        .name("Jenny")
        .addPhoneNumbers(8675309L)
        .build();

    assertEquals("Jenny", t.name());
    assertEquals(ImmutableList.of(8675309L), t.phoneNumbers());
    assertFalse(t.description().isPresent());
</pre>
<p>For more documentation, see the reference at <a href="http://immutables.github.io/immutable.html">immutables.github.io</a>.</p></div></article><nav><h3>Getting Started</h3><ul><li><a href="/buck/">Overview</a><li><a href="/buck/setup/quick_start.html">Quick Start</a><li><a href="/buck/setup/install.html">Downloading and Installing Buck</a><li><a href="/buck/article/exopackage.html">Exopackage</a></ul><h3>About</h3><ul><li><a href="/buck/concept/what_makes_buck_so_fast.html">What Makes Buck so Fast?</a><li><a href="/buck/concept/troubleshooting.html">Troubleshooting</a><li><a href="/buck/about/performance_tuning.html">Performance Tuning</a><li><a href="/buck/concept/faq.html">FAQ</a></ul><h3>Concepts</h3><ul><li><a href="/buck/concept/build_rule.html">Build Rule</a><li><a href="/buck/concept/build_target.html">Build Target</a><li><a href="/buck/concept/build_file.html">Build File</a><li><a href="/buck/concept/buckversion.html">.buckversion</a><li><a href="/buck/concept/nobuckcheck.html">.nobuckcheck</a><li><a href="/buck/concept/buckconfig.html">.buckconfig</a><li><a href="/buck/concept/build_target_pattern.html">Build Target Pattern</a><li><a href="/buck/concept/visibility.html">Visibility</a><li><a href="/buck/concept/http_cache_api.html">HTTP Cache API</a></ul><h3>Build Rules</h3><ul><li><a href="/buck/rule/android_binary.html">android_binary()</a><li><a href="/buck/rule/android_build_config.html">android_build_config()</a><li><a href="/buck/rule/android_library.html">android_library()</a><li><a href="/buck/rule/android_prebuilt_aar.html">android_prebuilt_aar()</a><li><a href="/buck/rule/android_resource.html">android_resource()</a><li><a href="/buck/rule/apk_genrule.html">apk_genrule()</a><li><a href="/buck/rule/gen_aidl.html">gen_aidl()</a><li><a href="/buck/rule/genrule.html">genrule()</a><li><a href="/buck/rule/java_binary.html">java_binary()</a><li><a href="/buck/rule/java_library.html">java_library()</a><li><a href="/buck/rule/java_test.html">java_test()</a><li><a href="/buck/rule/keystore.html">keystore()</a><li><a href="/buck/rule/ndk_library.html">ndk_library()</a><li><a href="/buck/rule/prebuilt_jar.html">prebuilt_jar()</a><li><a href="/buck/rule/prebuilt_native_library.html">prebuilt_native_library()</a><li><a href="/buck/rule/project_config.html">project_config()</a><li><a href="/buck/rule/python_binary.html">python_binary()</a><li><a href="/buck/rule/python_library.html">python_library()</a><li><a href="/buck/rule/python_test.html">python_test()</a></ul><h3>Functions</h3><ul><li><a href="/buck/function/glob.html">glob()</a><li><a href="/buck/function/include_defs.html">include_defs()</a><li><a href="/buck/function/string_parameter_macros.html">String Parameter Macros</a></ul><h3>Commands</h3><ul><li><a href="/buck/command/audit.html">buck audit</a><li><a href="/buck/command/build.html">buck build</a><li><a href="/buck/command/clean.html">buck clean</a><li><a href="/buck/command/install.html">buck install</a><li><a href="/buck/command/project.html">buck project</a><li><a href="/buck/command/quickstart.html">buck quickstart</a><li><a href="/buck/command/targets.html">buck targets</a><li><a href="/buck/command/test.html">buck test</a><li><a href="/buck/command/uninstall.html">buck uninstall</a><li><a href="/buck/command/buckd.html">buckd</a></ul><h3>Extending Buck</h3><ul><li><a href="/buck/extending/macros.html">Custom Macros</a><li><a href="/buck/extending/rules.html">Custom Rules</a></ul><h3>Contributing to Buck</h3><ul><li><a href="https://groups.google.com/group/buck-build">Discussion Group</a><li><a href="https://github.com/facebook/buck/issues/new">Report a Bug</a><li><a href="/buck/contributing/tour.html">Tour of the Codebase</a><li><a href="/buck/contributing/development.html">Development Workflow</a><li><a href="/buck/contributing/codestyle.html">Code Style</a><li><a href="/buck/contributing/logging.html">Logging</a><li><a href="/buck/contributing/immutables.html">Immutable Value Types</a><li><a href="/buck/javadoc">API</a><li><a href="https://github.com/facebook/buck">Browse the Source Code</a></ul></ul></nav></div></section><footer><div class='width'>&copy; Copyright Facebook, 2013 -</div></footer><script src="/buck/google-code-prettify/prettify.js"></script><script>prettyPrint()</script></body></html>